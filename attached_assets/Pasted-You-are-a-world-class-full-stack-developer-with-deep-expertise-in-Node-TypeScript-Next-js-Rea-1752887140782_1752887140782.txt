You are a **worldâ€‘class fullâ€‘stack developer** with deep expertise in NodeÂ +Â TypeScript, Next.js/React, Playwright, Supabase, highâ€‘performance caching, and automated testing.

**Context**: PhasesÂ 1â€“3 of the â€œsingleâ€‘scrapeÂ + singleâ€‘endpointâ€ migration are already merged. The codebase now exposes only:

* `GET /api/overview?url=â€¦` (readâ€‘only, returns full JSON blob)
* `POST /api/scan`          (idempotent trigger)

All frontend tabs render purely from the overview slice; legacy routes, hooks, and utils have been deleted.

Your task: **Implement PhasesÂ 4â€“6** to harden performance, reliability, and code qualityâ€”*without touching visual UI or adding brandâ€‘new endpoints.* Follow the order below and keep diffs surgical.

> **Do NOT** reopen or recreate any of the deleted legacy routes. Focus only on the items below.

---

## ðŸš€ PhaseÂ 4Â â€”Â Cache, Queue & Schema Guards

### Goals

1. Protect against stale JSON by embedding a **schemaVersion guard**.
2. Keep Playwright jobs from saturating the server: **bounded queue + perâ€‘domain throttling**.
3. Tune cache TTLs and payload size.

### ADD & MODIFY (in this order)

1. **MODIFY** `server/services/uiScraper.ts`
   â€¢ Add `const CURRENT_VERSION = '1.1.0'` (update as you evolve).
   â€¢ Before returning cached JSON, check `row.schemaVersion === CURRENT_VERSION`; if false, trigger a fresh scrape and return `{ status:'pending' }`.
   â€¢ Attach `schemaVersion: CURRENT_VERSION` to new results.
2. **ADD** `server/lib/queue.ts`
   â€¢ Export a `PQueue` instance with `concurrency = 3`.
   â€¢ Wrap `playwrightLaunch()` calls inside `queue.add(() => â€¦)`.
   â€¢ Add perâ€‘domain key using a `Map<string, Promise>` to avoid simultaneous scrapes of the same host.
3. **MODIFY** `server/lib/cache.ts`
   â€¢ Set TTL to 24â€¯h for successful scrapes, 15â€¯min for failed ones.
   â€¢ Move bulky artefacts (Lighthouse trace, screenshots) to Supabase storage bucket; cache only the presigned URLs.
4. **MODIFY** `server/routes/overview.ts`
   â€¢ If `getOrCreateAnalysis` returns `{ status:'pending' }`, respond **202 Accepted**; client already polls.

### DELETE (last)

* Any adâ€‘hoc `new PQueue` instantiations in other modulesâ€”centralise all queueing in `server/lib/queue.ts`.
* Remove inâ€‘file Playwright `await browser.close()` try/catch blocks now handled in the queued task.

---

## ðŸ§ª PhaseÂ 5Â â€”Â Automated Tests & CI

### Goals

* Prevent regressions on route shape, cache behaviour, and queue concurrency.

### ADD & MODIFY

1. **ADD** `tests/api/overview.test.ts`
   â€¢ Mocks `uiScraper` to return a dummy blob; assert 200 vs. 202 status codes.
2. **ADD** `tests/queue/queue.test.ts`
   â€¢ Spawn 10 parallel `getOrCreateAnalysis` calls for the same URL; assert queue length â‰¤3 and only **one** Playwright run (mock).
3. **ADD** GitHubÂ Actions workflow `.github/workflows/ci.yml`
   â€¢ Steps: checkout â†’ `pnpm install` â†’ `pnpm test` â†’ `pnpm build`.
4. **MODIFY** existing test scripts in `package.json` to include `--runInBand` if flaky.

### DELETE

* Remove obsolete snapshot tests that depended on legacy `/api/colors` etc.

---

## ðŸŽ¨ PhaseÂ 6Â â€”Â Type Cleanup & Security Hardening

### Goals

* Replace bespoke response types with derived generics.
* Lock down CORS and auth for the single public endpoint.

### ADD & MODIFY

1. **MODIFY** `types/index.d.ts`
   â€¢ `export type UIAnalysis = { colors: â€¦; fonts: â€¦; /* full shape */ ; schemaVersion: string }`.
   â€¢ `export type OverviewResponse = Awaited<ReturnType<typeof getOrCreateAnalysis>>`.
2. **MODIFY** `server/index.ts`
   â€¢ Apply CORS middleware: `origin: ['https://dashboard.yoursite.com']`.
   â€¢ Add simple API key check for `POST /api/scan` (`x-api-key` header).
3. **MODIFY** any component type imports to use the new `OverviewResponse`.

### DELETE

* `types/ColorSlice.d.ts`, `types/FontSlice.d.ts`, or any file duplicating the new unified typings.

---

## âœ… Validation Checklist (PhasesÂ 4â€‘6)

1. `GET /api/overview?url=â€¦` returns **202** on first hit (cold cache), **200** thereafter with `schemaVersion:'1.1.0'`.
2. Supabase table rows show `schemaVersion = '1.1.0'` and expire after 24â€¯h.
3. Queue never exceeds `concurrency = 3`; duplicate URL requests share the same promise.
4. Lighthouse trace URLs are signed and **<5Â kB** of JSON returns in `/overview`.
5. `pnpm test` passes locally and in GitHubÂ Actions.
6. No TypeScript errors after deleting legacy slice types.
7. CORS only allows the production dashboard origin; unauthenticated `POST /api/scan` returns **401**.

---

## ðŸ¤– Agent Guidance

1. **Think > Code** â€” inspect cache, queue, and schema codepaths first.
2. Apply **ADD / MODIFY** changes in the order above; run tests; then perform the **DELETE** cleanup.
3. Keep commits focused:

   * `feat(cache): add schemaVersion check & PQueue`
   * `test(api): add overview and queue tests`
   * `chore(types): unify OverviewResponse & remove slices`
4. No UI changesâ€”*pure backend & test work.*

Good luck finishing the migration!
