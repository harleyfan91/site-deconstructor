## ğŸš€ **Site Deconstructor â€“ 7â€‘Part Localâ€‘First Refactor**

Progress checklist:

1. SchemaÂ &Â migrations âœ…
2. Optimistic **POSTÂ /scans** stub & redirect âœ…
3. Worker & task fanâ€‘out loop âœ…
4. Reactâ€‘Query hooks + skeleton cards âœ…
5. **LocalStorage panelâ€‘state hook** â† *current task*
6. Realtime progress subscription
7. SupabaseÂ Auth + RLS

### â›”Â Hard constraints for **Partâ€¯5 (panelâ€‘state)**

* Only touch **clientâ€‘side React code** for remembering expanded/collapsed sections.
* Do **not** edit API routes, worker logic, Auth, or Realtime.
* Provide a Replitâ€‘preview test that requires no backend changes.

---

# PartÂ 5â€¯/â€¯7 â€“ Persist panel expansion per scan

\###Â ğŸ¯Â Goals

1. Implement a hook `usePanelState(scanId: string)` that stores a `{ [sectionId: string]: boolean }` map in **localStorage**, keyed by `panelState:<scanId>`.
2. Update each dashboard tab component (e.g. `UI.tsx`, `Tech.tsx`) to use this hook so that when a user toggles sections, state persists when navigation occurs.
3. If the JSON is malformed or missing, fall back to `{}` without throwing.
4. Provide a local manual test in Replit preview: expand two sections, leave tab, return â†’ same sections still expanded.

---

\##Â 1Â Â·Â Create hook file \`\`

```ts
import { useEffect, useState, useCallback } from "react";

type PanelMap = Record<string, boolean>;

export function usePanelState(scanId: string) {
  const key = `panelState:${scanId}`;

  const [state, setState] = useState<PanelMap>(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? (JSON.parse(raw) as PanelMap) : {};
    } catch {
      return {};
    }
  });

  // persist on change
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {
      /* ignore quota errors */
    }
  }, [key, state]);

  // helper toggle
  const toggle = useCallback(
    (sectionId: string) =>
      setState((prev) => ({ ...prev, [sectionId]: !prev[sectionId] })),
    []
  );

  return { state, toggle } as const;
}
```

\##Â 2Â Â·Â Integrate into tab components Example for \`\` (apply similar to other tabs):

```tsx
import { usePanelState } from "../../hooks/usePanelState";

export function UITab({ scanId }: { scanId: string }) {
  const { state, toggle } = usePanelState(scanId);

  return (
    <Accordion type="multiple" value={Object.keys(state).filter((k) => state[k])}>
      <AccordionItem value="layout" onValueChange={() => toggle("layout")}> â€¦ </AccordionItem>
      <AccordionItem value="contrast" onValueChange={() => toggle("contrast")}> â€¦ </AccordionItem>
      {/* other sections */}
    </Accordion>
  );
}
```

*If your UI uses a different collapsible component, adapt the props while keeping the same **`toggle()`** logic.*

\##Â 3Â Â·Â Manual test in Replit

1. `npm run dev` (Vite UI) â€” no need for server/worker.
2. Navigate to an existing dashboard URL (or create a new scan).
3. Expand two sections in the UI tab.
4. Switch to Tech tab, then come back to UI â†’ expanded sections remain.
5. Hardâ€‘reload the preview â†’ sections still expanded for that scan; perform a different scan â†’ state isolated by scanId.

---

\###Â Commit

```bash
git add client/src/hooks/usePanelState.ts client/src/pages/tabs/*
git commit -m "feat: persist panel expand/collapse per scan via localStorage hook"
```
